# 修正内容の正確な説明

**作成日**: 2025年08月01日

## 🔍 発見された問題（プログラムのバグ）

### 1. 循環参照バグ
**場所**: time_axis_shortage_calculator.py
**内容**: 
```python
# バグのあるコード（概念）
estimated_demand = f(shortage_baseline)
shortage_baseline = f(estimated_demand)
```
→ 無限ループ的な増幅が発生

### 2. 期間の重複乗算バグ
**場所**: build_stats.py
**内容**: 既に合計された値に更に期間日数を乗算
→ 92日間なら92倍に膨らむ

### 3. 統計手法の問題
**内容**: 75パーセンタイル使用による恒常的な過大推定

## 🔧 実際の修正内容

### 修正1: 循環参照の排除
```python
# 修正後
estimated_demand = total_supply * 1.05  # 独立計算
```
**注意**: これは「強制的に1.05倍」ではありません。
循環参照を断ち切るための独立計算です。

### 修正2: 重複乗算の修正
期間の乗算を1回だけに修正（当然の修正）

### 修正3: 異常値検出機能の追加
```python
if daily_shortage > reasonable_limit:
    log.error("計算エラーの可能性")
```
**注意**: これは制限ではなく、エラー検出機能です。

## ✅ 保証されていること

### Need計算の完全性
1. **元データは変更なし**: Excelからの読み込みはそのまま
2. **時間帯別詳細は保持**: 全ての時間帯のデータは保存
3. **ピンポイント分析可能**: 必要な時間帯を特定可能

### 不足時間計算の正確性
- **基本式**: Shortage = Need - Staff
- **単純な引き算**: 操作や制限はなし
- **詳細データ**: 全て保持

## 🎯 要点

### やったこと
1. **プログラムのバグ修正**
2. **エラー検出機能の追加**
3. **統計手法の見直し提案**

### やっていないこと
1. **Need値の操作**: ❌ していません
2. **データの制限**: ❌ していません
3. **真実の隠蔽**: ❌ していません

## 結論

修正は「プログラムのバグ修正」であり、データの操作ではありません。

- **循環参照バグ**: プログラミングエラーを修正
- **重複乗算バグ**: 計算ミスを修正
- **異常値検出**: エラーを早期発見するため

Need計算の完全性、時間帯別の詳細分析能力は完全に保持されています。
