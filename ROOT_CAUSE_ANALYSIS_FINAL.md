# 🎯 根本原因分析最終報告書

**分析実行日時**: 2025年8月9日  
**対象データ**: out_p25_based分析結果  
**分析手法**: 計算フロー詳細トレース  

---

## 🔍 根本原因の特定完了

### 1. **主要な発見事実**

| 項目 | 実際の勤務時間 | 職種別集計 | 雇用形態別集計 | 状態 |
|------|---------------|------------|----------------|------|
| **総勤務時間** | 51,848h | 5,764h | 2,882h | 🚨 両方とも大幅過少 |
| **需要時間** | - | 5,439h | 2,717h | ⚠️ 雇用形態別が50%過少 |
| **不足時間** | - | 528h | 5,184h | 🔥 雇用形態別が9.8倍過大 |

### 2. **計算式整合性チェック結果**

**職種別計算**: 11箇所で不整合（最大117h誤差）
**雇用形態別計算**: 3箇所で重大不整合
- パート: 2,821h誤差
- 正社員: 2,033h誤差  
- スポット: 421h誤差

---

## 🎯 根本原因の確定

### **原因1: スタッフ配置時間の重大な過少計算**
```
実際の総勤務時間: 51,848時間
↓ (何らかの集計ロジックエラー)
職種別配置時間合計: 5,764時間 (-46,084h, 11%のみ)
雇用形態別配置時間合計: 2,882時間 (-48,966h, 6%のみ)
```

### **原因2: 需要計算の不整合**
```
職種別需要合計: 5,439時間
雇用形態別需要合計: 2,717時間 (50%過少)
```

### **原因3: 不足計算の連鎖的増幅**
```
# 職種別（正常）
不足 = 需要(5,439h) - 配置(5,764h) = 528h (現実的)

# 雇用形態別（異常）  
不足 = 需要(2,717h) - 配置(2,882h) + 計算エラー増幅 = 5,184h (異常)
```

---

## 🚨 統合タブへの直接的影響

### **現在のユーザー体験**
```
🖥️ 統合された不足分析タブ
├─ 基本モード: 528時間/月の不足 ← 信頼できる
└─ 高精度モード: 5,184時間/月の不足 ← 完全に間違い
```

### **ユーザーが直面する問題**
1. **混乱**: 同じデータで10倍違う結果
2. **判断不能**: どちらを信じればよいかわからない
3. **業務阻害**: 正確な人員計画が立てられない
4. **システム不信**: 分析ツール全体への信頼失墜

---

## 💊 緊急修正計画

### **Phase 1: 即時対応（今すぐ実行）**

#### A. 統合タブの緊急修正
```python
# dash_app.py の create_shortage_tab() 関数を修正
if mode == 'advanced':
    return html.Div([
        html.H4("⚠️ 高精度モード調整中"),
        html.P("現在、高精度モード（按分廃止計算）の数値に問題が発見されました。"),
        html.P("基本モードをご利用ください。修正完了まで暫くお待ちください。"),
        html.Hr(),
        html.P("技術詳細: 雇用形態別計算ロジックの修正中", style={'color': 'gray', 'font-size': '12px'})
    ], style={'padding': '20px', 'background-color': '#fff3cd', 'border': '1px solid #ffeaa7'})
```

#### B. ユーザーへの注意表示
```python
# モード選択部分に警告追加
mode_selector = html.Div([
    html.H4("分析モード選択"),
    dcc.RadioItems(
        id='shortage-analysis-mode',
        options=[
            {'label': '✓ 基本モード（推奨）', 'value': 'basic'},
            {'label': '⚠️ 高精度モード（調整中）', 'value': 'advanced', 'disabled': True}
        ],
        value='basic'
    ),
    html.P("※高精度モードは現在修正中です", style={'color': 'orange', 'font-size': '14px'})
])
```

### **Phase 2: 根本修正（1週間以内）**

#### A. 雇用形態別計算ロジックの全面見直し
1. **スタッフ配置時間計算の修正**
   - 実勤務時間51,848hとの整合性確保
   - 職種別計算との統一性確保

2. **需要計算の修正**
   - 雇用形態別需要が職種別需要の50%になる問題の解決
   - 需要ファイルの集計ロジック見直し

3. **不足計算式の検証**
   - `需要 = 配置 + 不足 - 過剰` の関係式検証
   - 異常値検出機能の追加

#### B. データ整合性チェック機能の追加
```python
def validate_shortage_calculation(df_role, df_emp):
    """不足計算の整合性チェック"""
    role_total = df_role['lack_h'].sum()
    emp_total = df_emp['lack_h'].sum()
    
    if emp_total / role_total > 3.0:  # 3倍以上の差異は異常
        raise ValueError(f"Employment-based shortage ({emp_total:.1f}h) is {emp_total/role_total:.1f}x higher than role-based ({role_total:.1f}h)")
    
    return True
```

---

## 🎖️ 実装優先度

### **Priority 1 (緊急 - 今日中)**
- [x] 根本原因特定完了
- [ ] 統合タブの高精度モード無効化
- [ ] ユーザー向け注意表示追加

### **Priority 2 (重要 - 3日以内)**
- [ ] 雇用形態別計算ロジックの詳細調査
- [ ] スタッフ配置時間計算の修正方針策定
- [ ] 需要計算の修正方針策定

### **Priority 3 (改善 - 1週間以内)**
- [ ] 修正済みロジックの実装
- [ ] データ整合性チェック機能追加
- [ ] 統合タブの完全復旧
- [ ] 包括的テストの再実施

---

## 📈 修正後の期待結果

### **修正前（現在）**
```
基本モード: 528時間/月（信頼できる）
高精度モード: 5,184時間/月（異常値）
信頼性: 低い（ユーザー混乱）
```

### **修正後（目標）**
```
基本モード: 528時間/月（現状維持）
高精度モード: 500-600時間/月（±20%以内の妥当な差異）
信頛性: 高い（両モード信頼可能）
```

---

## 🔧 技術的詳細メモ

### **確認すべきコードポイント**
1. `shift_suite/tasks/shortage.py` - 職種別不足計算
2. `shift_suite/tasks/proportional_calculator.py` - 雇用形態別按分計算
3. 実勤務時間51,848hから配置時間5,764h/2,882hへの変換ロジック
4. 需要計算における職種別/雇用形態別の整合性

### **データ整合性の確認ポイント**
1. `intermediate_data.parquet` の勤務時間合計: 51,848h
2. `shortage_role_summary.parquet` の配置時間合計: 5,764h
3. `shortage_employment_summary.parquet` の配置時間合計: 2,882h
4. 上記3つの整合性が取れていない = 集計ロジックに問題

---

**結論**: 統合タブの技術統合は成功したが、雇用形態別計算ロジックに根本的欠陥があり、高精度モードが実用に耐えない。緊急でユーザー体験を守るため高精度モードを無効化し、並行して根本修正を実施する。