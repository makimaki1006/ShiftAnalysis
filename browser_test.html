<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ブラウザー機能テスト</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>🧪 ブラウザー機能テスト</h1>
    <p>このページでJavaScript機能をテストして、Dashアプリケーションの問題を特定します。</p>
    
    <div id="results"></div>
    
    <script>
        function addResult(test, passed, details = '') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-result ${passed ? 'success' : 'error'}`;
            div.innerHTML = `
                <strong>${test}:</strong> ${passed ? '✅ 合格' : '❌ 失敗'}
                ${details ? `<br><small>${details}</small>` : ''}
            `;
            results.appendChild(div);
        }
        
        // 基本JavaScript機能テスト
        addResult('基本JavaScript実行', true, 'このメッセージが表示されています');
        
        // ES6機能テスト
        try {
            const arrow = () => 'ES6 Arrow Function';
            const [a, b] = [1, 2];
            addResult('ES6機能', true, 'アロー関数と分割代入が動作');
        } catch (e) {
            addResult('ES6機能', false, e.message);
        }
        
        // Fetch API テスト
        if (typeof fetch !== 'undefined') {
            addResult('Fetch API', true, 'モダンHTTPリクエスト機能利用可能');
        } else {
            addResult('Fetch API', false, 'Fetch APIが利用できません');
        }
        
        // Promise テスト
        try {
            new Promise((resolve) => resolve('test'))
                .then(() => addResult('Promise', true, '非同期処理機能が正常'));
        } catch (e) {
            addResult('Promise', false, e.message);
        }
        
        // LocalStorage テスト
        try {
            localStorage.setItem('test', 'value');
            localStorage.removeItem('test');
            addResult('LocalStorage', true, 'ブラウザーストレージ機能正常');
        } catch (e) {
            addResult('LocalStorage', false, e.message);
        }
        
        // React 動作テスト (CDN経由)
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/react@18/umd/react.development.js';
        script.onload = () => {
            if (typeof React !== 'undefined') {
                addResult('React CDN読み込み', true, `React version: ${React.version}`);
            } else {
                addResult('React CDN読み込み', false, 'Reactオブジェクトが作成されませんでした');
            }
        };
        script.onerror = () => {
            addResult('React CDN読み込み', false, 'React CDNの読み込みに失敗');
        };
        document.head.appendChild(script);
        
        // ローカルDashアプリケーションテスト
        setTimeout(() => {
            fetch('http://127.0.0.1:8053/')
                .then(response => {
                    if (response.ok) {
                        addResult('ローカルDashアプリ接続', true, `Status: ${response.status}`);
                        return response.text();
                    } else {
                        addResult('ローカルDashアプリ接続', false, `HTTP ${response.status}`);
                    }
                })
                .then(html => {
                    if (html && html.includes('react-entry-point')) {
                        addResult('Dashページ構造', true, 'React entry pointが存在');
                        
                        if (html.includes('_dash-loading')) {
                            addResult('Dashレンダリング状態', false, 'Loading状態で停止している可能性');
                        } else {
                            addResult('Dashレンダリング状態', true, '正常にレンダリング完了');
                        }
                    } else {
                        addResult('Dashページ構造', false, '期待されるHTML構造が見つかりません');
                    }
                })
                .catch(error => {
                    addResult('ローカルDashアプリ接続', false, error.message);
                });
        }, 3000);
        
        // 5秒後に最終診断
        setTimeout(() => {
            const results = document.getElementById('results');
            const summary = document.createElement('div');
            summary.style.marginTop = '20px';
            summary.style.padding = '15px';
            summary.style.backgroundColor = '#e7f3ff';
            summary.style.borderRadius = '5px';
            summary.innerHTML = `
                <h3>🎯 診断結果</h3>
                <p><strong>ブラウザー:</strong> ${navigator.userAgent}</p>
                <p><strong>時刻:</strong> ${new Date().toLocaleString()}</p>
                <p>上記のテスト結果を確認して、Dashアプリケーションの問題箇所を特定してください。</p>
            `;
            results.appendChild(summary);
        }, 8000);
    </script>
</body>
</html>