#!/usr/bin/env python3
"""
不足時間異常値の診断
48,972時間という異常な値の原因を分析
"""

def diagnose_shortage_issue():
    """不足時間異常値の診断"""
    
    print("🔍 === 不足時間異常値（48,972時間）の診断 ===\n")
    
    print("【現象】")
    print("- p25_basedシナリオで総不足時間が48,972時間")
    print("- 介護職種だけで17,482時間の不足")
    print("- これは1ヶ月あたり約1,600時間/日の不足で非現実的")
    print("")
    
    print("【可能性1: スロット時間の誤計算】")
    print("- 通常: 30分スロット = 0.5時間")
    print("- もし48,972がスロット数なら: 48,972 × 0.5 = 24,486時間")
    print("- それでも大きすぎる → これが原因ではない")
    print("")
    
    print("【可能性2: 日数の重複カウント】")
    print("- 1ヶ月30日として: 48,972 ÷ 30 = 1,632時間/日")
    print("- 1日24時間なので: 1,632 ÷ 24 = 68倍")
    print("- → 何かが68回重複してカウントされている？")
    print("")
    
    print("【可能性3: 複数月の累積】")
    print("- もし12ヶ月分なら: 48,972 ÷ 12 = 4,081時間/月")
    print("- それでも1ヶ月あたり136時間/日で異常")
    print("")
    
    print("【可能性4: スタッフ数との掛け算】")
    print("- もし50人のスタッフがいて、各人の不足を合計すると")
    print("- 980時間/人 × 50人 = 49,000時間")
    print("- → スタッフ別の不足を誤って合計している可能性")
    print("")
    
    print("【最も可能性が高い原因】")
    print("✅ **複数の集計軸での重複カウント**")
    print("   - 職種別集計: 48,972時間")
    print("   - 雇用形態別集計: 26,175時間")
    print("   - 合計すると: 75,147時間")
    print("")
    print("   → 同じ不足が「職種」と「雇用形態」で別々にカウントされ、")
    print("     さらにそれらが合計されている可能性")
    print("")
    
    print("【推奨確認事項】")
    print("1. shortage.pyでの集計ロジック確認")
    print("   - role_kpi_rowsとemp_kpi_rowsが独立して計算されているか")
    print("   - 最終的な合計でこれらを重複して加算していないか")
    print("")
    print("2. データの重複確認")
    print("   - 同じスタッフが複数の職種/雇用形態に属していないか")
    print("   - 日付の重複カウントがないか")
    print("")
    print("3. 計算単位の確認")
    print("   - スロット数と時間の変換が正しいか")
    print("   - 人数×時間の計算が正しいか")

if __name__ == "__main__":
    diagnose_shortage_issue()